<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        #map { height: 720px; }
        #offlinemap-controls {background-color:#b0c4de; }
        #offlinemap-controls-counter {margin-left:auto; margin-right:auto; width:70%;}
    </style>

    <link rel="stylesheet" href="./leaflet.css" />
    <script type="text/javascript" src="./leaflet.js"></script>
    <script type="text/javascript" src="./IndexedDBShim.min.js"></script>
    <script type="text/javascript" src="../dist/offlinemap.js"></script>
    <script>
        mapquestUrl = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png'
        subDomains = ['otile1','otile2','otile3','otile4']
        mapquestAttrib = 'Data, imagery and map information provided by <a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>, <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors.'
    </script>
</head>
<body>
    <div id="map"></div>
    <script>
        /* An example of control that can be used for saving tiles */
        var CacheBtnControl = L.Control.extend({
            options: {
                position: 'topright'
            },

            onAdd: function (map) {
                var controls = L.DomUtil.create('div', 'control-button', this._container);

                var cacheButton = L.DomUtil.create('input', 'cache-button', controls);
                cacheButton.setAttribute('type', "button");
                cacheButton.setAttribute('id', "Btn1");
                cacheButton.setAttribute('value', "Cache");

                L.DomEvent.addListener(cacheButton, 'click', this.onCacheClick, this);
                L.DomEvent.disableClickPropagation(cacheButton);

                var cacheTo17Button = L.DomUtil.create('input', 'cache-up-to-button', controls);
                cacheTo17Button.setAttribute('type', "button");
                cacheTo17Button.setAttribute('id', "Btn1");
                cacheTo17Button.setAttribute('value', "Cache up to 17");

                L.DomEvent.addListener(cacheTo17Button, 'click', this.onCacheUpToClick, this);
                L.DomEvent.disableClickPropagation(cacheTo17Button);

                var clearButton = L.DomUtil.create('input', 'offlinemap-controls-clear-button', controls);
                clearButton.setAttribute('type', "button");
                clearButton.setAttribute('id', "clearBtn");
                clearButton.setAttribute('value', "Clear DB");

                L.DomEvent.addListener(clearButton, 'click', this.onClearClick, this);
                L.DomEvent.disableClickPropagation(clearButton);

                return controls;
            },

            onClearClick: function (){
                offlineLayer.clearTiles();
            },

            onCacheClick: function (){
                // Might be a good idea to put a limit on the number of tiles that can would be saved
                // calculateNbTiles includes potentially already saved tiles.
                var nbTiles = offlineLayer.calculateNbTiles();
                if(nbTiles < 10000){
                    console.log("Will be saving: " + nbTiles + " tiles");
                    // the actual call to save the tiles
                    //offlineLayer.saveTiles();
                    offlineLayer.saveTiles(17);
                }
                else{
                    alert("You are trying to save " + nbTiles + " tiles. There is currently a limit of 10,000 tiles.");
                }
            },

            onCacheUpToClick : function (){
                var nbTiles = offlineLayer.calculateNbTiles(17);
                if(nbTiles < 10000){
                    console.log("Will be saving: " + nbTiles + " tiles");
                    // the actual call to save the tiles
                    //offlineLayer.saveTiles();
                    offlineLayer.saveTiles(17);
                }
                else{
                    alert("You are trying to save " + nbTiles + " tiles. There is currently a limit of 10,000 tiles.");
                }
            }
        });

        var aMap = L.map('map').setView([-2.9, -79], 13);

        var onReady = function(){
            console.log("The OfflineLayer is ready to be used");
            offlineLayer.addTo(aMap);
            var cacheBtn = new CacheBtnControl();
            aMap.addControl(cacheBtn);
            var progressControls = new OfflineProgressControl();
            progressControls.setOfflineLayer(offlineLayer);
            aMap.addControl(progressControls);
        }
        var onError = function(errorType, errorData1, errorData2){
            console.log(errorType);
            console.log(errorData1);
            console.log(errorData2);
        }
        var offlineLayer = new OfflineLayer( mapquestUrl, { /*leaflet TileLayer basic options: */ maxZoom: 18,
                                             attribution: mapquestAttrib, subdomains: subDomains,
                                            /*OfflineLayer specific options: */
                                            onReady: onReady, /*optional*/onError: onError,
                                            /*optional*/storeName:"myStoreName"});
    </script>
</body>
</html>